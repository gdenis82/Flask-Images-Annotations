<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} - YOLO Annotation Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">YOLO Annotation Tool</a>
            <span class="navbar-text text-light me-3">
                Project: {{ project_name }}
            </span>
        </div>
    </nav>

    <div class="annotation-container">
        <div class="sidebar">
            <div class="mb-3">
                <h5>Images</h5>
                <input type="file" id="imageUpload" accept="image/*" multiple style="display: none;">
                <input type="file" id="folderUpload" webkitdirectory directory multiple style="display: none;">
                <div class="image-list" id="imageList">
                    <!-- Images will be loaded here -->
                    <div class="alert alert-info">No images added yet. Use the Images dropdown to add images.</div>
                </div>
            </div>

            <div class="annotation-controls">
                <h5>Annotation</h5>

                <div class="class-selector mb-3 d-flex align-items-center" style="min-width: 150px;">
                    <select class="form-select form-select-sm" id="classSelect">
                        {% for class in classes %}
                        <option value="{{ loop.index0 }}">{{ class }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <h6>Annotations List</h6>
                    <div class="annotations-list" id="annotationsList">
                        <!-- Annotations will be loaded here -->
                        <div class="alert alert-info">No annotations yet.</div>
                    </div>
                </div>

            </div>
        </div>

        <div class="main-content">
            <div class="toolbar">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="btn-group me-3" role="group" aria-label="Annotation Tools">
                            <button type="button" class="btn btn-outline-primary tool-btn active" id="polygonTool" data-tool="polygon">
                                <i class="bi bi-pentagon"></i> Polygon
                            </button>
                            <button type="button" class="btn btn-outline-primary tool-btn" id="boxTool" data-tool="box">
                                <i class="bi bi-square"></i> Box
                            </button>
                        </div>

                        <!-- Image Management Dropdown -->
                        <div class="dropdown me-3">
                            <button class="btn btn-outline-primary dropdown-toggle" type="button" id="imageManagementDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-images"></i> Images
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="imageManagementDropdown">
                                <li><a class="dropdown-item" href="#" id="uploadImagesDropdownBtn"><i class="bi bi-upload"></i> Add Images</a></li>
                                <li><a class="dropdown-item" href="#" id="uploadFolderDropdownBtn"><i class="bi bi-folder-plus"></i> Add Folder</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" id="deleteAllImagesDropdownBtn"><i class="bi bi-trash"></i> Delete All Images</a></li>
                            </ul>
                        </div>
                    </div>

                    <!-- Navigation Arrows -->
                    <div class="d-flex align-items-center">
                        <div class="btn-group" role="group" aria-label="Image Navigation">
                            <button type="button" class="btn btn-outline-primary" id="prevImageBtn">
                                <i class="bi bi-arrow-left"></i> Previous
                            </button>
                            <span class="mx-3 d-flex align-items-center" id="imageCounter">Image 0 of 0</span>
                            <button type="button" class="btn btn-outline-primary" id="nextImageBtn">
                                Next <i class="bi bi-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <div class="btn-group d-flex align-items-center" role="group" aria-label="Zoom Controls">
                        <button type="button" class="btn btn-outline-secondary" id="zoomIn">
                            <i class="bi bi-zoom-in"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="zoomOut">
                            <i class="bi bi-zoom-out"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" id="zoomReset">
                            <i class="bi bi-aspect-ratio"></i> Reset
                        </button>
                    </div>
                </div>
            </div>

            <div class="image-container" id="imageContainer">
                <div class="canvas-container" id="canvasContainer">
                    <canvas id="imageCanvas"></canvas>
                    <canvas id="annotationCanvas"></canvas>
                </div>
                <div class="alert alert-info text-center" id="noImageMessage">
                    No image selected. Please select an image from the sidebar or add new images.
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exportModalLabel">Export to YOLO Format</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>This will export your annotations in YOLO format with the following structure:</p>
                    <pre>
dataset_yolo/
├── data.yaml
├── train/
│   ├── images/
│   └── labels/
└── val/
    ├── images/
    └── labels/
                    </pre>
                    <p>The annotations will be saved in the following formats:</p>
                    <ul>
                        <li>For bounding boxes: <code>&lt;class_id&gt; &lt;x_center_norm&gt; &lt;y_center_norm&gt; &lt;width_norm&gt; &lt;height_norm&gt;</code></li>
                        <li>For polygons: <code>&lt;class_id&gt; &lt;x1&gt; &lt;y1&gt; &lt;x2&gt; &lt;y2&gt; ... &lt;xn&gt; &lt;yn&gt;</code></li>
                    </ul>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmExportBtn">Export</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Settings Modal -->
    <div class="modal fade" id="projectSettingsModal" tabindex="-1" aria-labelledby="projectSettingsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="projectSettingsModalLabel">Project Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="projectSettingsForm">
                        <div class="mb-3">
                            <label for="projectName" class="form-label">Project Name</label>
                            <input type="text" class="form-control" id="projectName">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Classes</label>
                            <div id="classesContainer">
                                <!-- Classes will be loaded here dynamically -->
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" id="addClass">Add Class</button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveProjectSettingsBtn">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Class Item Template -->
    <template id="classItemTemplate">
        <div class="class-item mb-2">
            <div class="input-group">
                <input type="text" class="form-control class-name" placeholder="Class name">
                <input type="color" class="form-control form-control-color class-color" title="Choose class color">
                <button class="btn btn-outline-danger remove-class" type="button">Remove</button>
            </div>
        </div>
    </template>

    <script>
        // Pass project data to JavaScript
        const projectId = "{{ project_id }}";
        const projectClasses = {{ classes|tojson }};
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('serve_socketio_client') }}"></script>
    <script src="{{ url_for('static', filename='js/annotation.js') }}"></script>
</body>
</html>
